name: ci
on:
  pull_request:
  push:
    branches:
    - master
    - ci
  schedule:
  - cron: '00 01 * * *'

jobs:
  test-complete:
    name: Run test-complete
    env:
      BITBAKE_URL: https://git.openembedded.org/bitbake
      OECORE_URL: https://git.openembedded.org/openembedded-core
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install packages
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          chrpath \
          diffstat \
          git \
          zsh
        sudo locale-gen en_US.UTF-8

    - name: Cache bitbake
      id: cache-bitbake
      uses: actions/cache@v4
      with:
        path: bitbake
        key: ${{ runner.os }}-bitbake-git

    - name: Fresh clone bitbake
      if: steps.cache-bitbake.outputs.cache-hit != 'true'
      run: git clone --single-branch $BITBAKE_URL bitbake

    - name: Cache oecore
      id: cache-oecore
      uses: actions/cache@v4
      with:
        path: oecore
        key: ${{ runner.os }}-oecore-git

    - name: Fresh clone oecore
      if: steps.cache-oecore.outputs.cache-hit != 'true'
      run: git clone --single-branch $OECORE_URL oecore

    - name: Update repositories
      run: |
        git -C bitbake pull origin master
        git -C oecore pull origin master

    - name: Test zsh shell completions
      run: ci/run
